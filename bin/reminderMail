#!/usr/bin/env node

var pg = require('pg');
var sendgrid  = require('sendgrid')(process.env.SENDGRID_API);
var helper = require('sendgrid').mail;
var from_email = new helper.Email('notifications@lunchWith.com');
var subject = 'You have new messages waiting for you on lunchWith!';
var content = new helper.Content('text/plain', 'Log in at https://lunchWith.herokuapp.com to view your messages!');


var request = sendgrid.emptyRequest({
  method: 'POST',
  path: '/v3/mail/send',
  body: mail.toJSON(),
});


pg.connect(process.env.DATABASE_URL, function(err, client, done) {
  var handleError = function(err) {
    if(!err) return false;
    done(client);
    next(err);
    return true;
  };

  client.query("SELECT recipient_id FROM messages WHERE new = true AND (messagetime, messagetime) OVERLAPS (current_timestamp, - interval '1 day') GROUP BY recipient_id;", function(err, result) {
    if(handleError(err, client, done)) return;

    if (result.rows.length > 0) {
      for (var i = 0; i < result.rows.length; i++) {
        console.log(result);
        // var to_email = new helper.Email('wolfsonk@gmail.com');
        // var mail = new helper.Mail(from_email, subject, to_email, content);
      }

      sendgrid.API(request, function(error, response) {
        }, function(err, json) {
          if (err) {
            console.error(err);
          }

          done();
          pg.end();
      });
    }
  });
});
