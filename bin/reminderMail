#!/usr/bin/env node

var db = require('../server/pghelper');
var pg = require('pg');
var sendgrid  = require('sendgrid')(process.env.SENDGRID_API);
var helper = require('sendgrid').mail;
var from_email = new helper.Email('notifications@lunchWith.com');
var subject = 'You have new messages waiting for you on lunchWith!';
var content = new helper.Content('text/plain', 'Log in at https://lunchWith.herokuapp.com to view your messages!');


db.query("SELECT recipient_id FROM messages WHERE new = true AND (messagetime, messagetime) OVERLAPS (current_timestamp, - interval '1 day') GROUP BY recipient_id;")
.then(function(usersToEmail){
  console.log("users to email: ", usersToEmail);
    if (result.rows.length > 0) {
      for (var i = 0; i < result.rows.length; i++) {
        var recipientId = result.rows[i].recipient_id;
        var sql = "SELECT emailaddress FROM users WHERE id = " + recipientId + ";"
        console.log("sql: ", sql)
        db.query(sql)
        .then(function(resultWithEmailAddress){
          console.log("this is the result of the nested query: ", resultWithEmailAddress);
          var to_email = new helper.Email(secondResult.rows[0].emailaddress);
          var mail = new helper.Mail(from_email, subject, to_email, content);
          var request = sendgrid.emptyRequest({
            method: 'POST',
            path: '/v3/mail/send',
            body: mail.toJSON(),
          });
          sendgrid.API(request, function(error, response) {
            }, function(err, json) {
              if (err) {
                console.error(err);
              }
          });
        })
    }
  }
});
